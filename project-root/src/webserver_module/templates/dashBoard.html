{% extends 'base.html' %}

{% block sidebar %}
  <div class="sidebar">
    <h2>Directory</h2>
    <form id="directory" class="filterForm" action="{{ url_for('home.dashBoardViewer') }}" method="GET">
      <input type="hidden" name="folderPath" value="your/folderPath">
    </form>
  </div>
{% endblock %}

{% block viewContent %}
  <div class="mainContent">
    
  </div>
  <script type="text/javascript">
    // Variables from initial website load via Jinja Syntax
    const liveDataHeaderJSON = '{{ liveDataHeaderJSON | tojson }}';
    liveDataHeaderBuffer = JSON.parse(liveDataHeaderJSON);
    if (liveDataHeaderBuffer == null){
      liveDataHeaderBuffer = [];
    }
    const liveDataHeader = liveDataHeaderBuffer;
    window.onload = function() {
      for(var i = 0; i < liveDataHeader.length; i++){
        loadLiveData(liveDataHeader[i]);
      }
    };

    function loadLiveData(liveDataHeaderRow){
      var mainListElement = document.createElement("div");
      mainListElement.className = "listElement";
      mainListElement.id = "listElement_" + liveDataHeaderRow;
      document.querySelector(".mainContent").appendChild(mainListElement);
      var xhr = new XMLHttpRequest();
      xhr.open('POST', "{{ url_for('home.getLiveData') }}", true);
      // Prepare FormData
      var formData = new FormData();
      formData.append('selectedLiveData', liveDataHeaderRow);
      // Define the reaction on the server response
      xhr.onload = function() {
        if (xhr.status === 200) {
          var liveDataRow = JSON.parse(xhr.responseText);
          mainListElement = document.getElementById("listElement_" + liveDataRow['id']);
          var listElementContent = document.createElement("div");
          listElementContent.className = "listElementContent";
          mainListElement.appendChild(listElementContent);
          var article = document.createElement("article");
          article.className = "rowArticle";
          listElementContent.appendChild(article);
          var header = document.createElement("header");
          article.appendChild(header);
          header.innerText = liveDataRow['name'];
          var p = document.createElement("p");
          p.id = "liveData_"+liveDataRow['id'];
          p.innerText = 'No value';
          article.appendChild(p);

          // Container for the Buttons
          var listElementAction = document.createElement("div");
          listElementAction.className = "listElementAction";
          listElementAction.id = "listElementAction_" + liveDataRow['id'];
          mainListElement.appendChild(listElementAction);

          if(liveDataRow['id'] == 1){
            // Add a button to start measurement of the distance
            var buttonStart = document.createElement("button");
            buttonStart.className = "button";
            buttonStart.innerHTML = '<ion-icon name="pulse-outline"></ion-icon> Start Measurement';
            buttonStart.id = "buttonStart_" + liveDataRow['id'];
            buttonStart.classList.add("action");
            listElementAction.appendChild(buttonStart);
            buttonStart.addEventListener('click', function(event) {
              var measuredValueElement = document.getElementById("liveData_1");
              measuredValueElement.innerHTML = "<ion-icon name='hourglass-outline'></ion-icon>";
              // Disable the button
              buttonStart.disabled = true;
              //Hide the button
              buttonStart.style.display = "none";
              // AJAX Request to start the measurement and write the response in the listElementContent
              var xhr = new XMLHttpRequest();
              xhr.open('POST', "{{ url_for('home.measureWaterLevel') }}", true);
              // Prepare FormData
              var formData = new FormData();
              // Define the reaction on the server response
              xhr.onload = function() {
                if (xhr.status === 200) {
                  var waterLevel = JSON.parse(xhr.responseText);
                  measuredValueElement.innerHTML = waterLevel + " mm";
                  // Enable the button
                  buttonStart.disabled = false;
                  // Show the button
                  buttonStart.style.display = "block";
                }
              }
              // Send the request with formData
              xhr.send(formData);

            });

            // Add a button to reset the zeroWaterLevelDistance
            var buttonReset = document.createElement("button");
            buttonReset.className = "button";
            buttonReset.innerHTML = '<ion-icon name="chevron-collapse-outline"></ion-icon> Set Zero Level';
            buttonReset.id = "buttonReset_" + liveDataRow['id'];
            buttonReset.classList.add("action");
            listElementAction.appendChild(buttonReset);
            buttonReset.addEventListener('click', function(event) {
              buttonReset.disabled = true;
              buttonReset.innerHTML = '<ion-icon name="hourglass-outline"></ion-icon>';
              // AJAX Request to reset the zeroWaterLevelDistance and write the response in the Button Text
              var xhr = new XMLHttpRequest();
              xhr.open('POST', "{{ url_for('home.setZeroWaterLevelDistance') }}", true);
              // Prepare FormData
              var formData = new FormData();
              // Define the reaction on the server response
              xhr.onload = function() {
                if (xhr.status === 200) {
                  buttonReset.disabled = false;
                  buttonReset.innerHTML = '<ion-icon name="chevron-collapse-outline"></ion-icon> Set Zero Level (Currently: ' + xhr.responseText + ' mm)';
                }
              }
              // Send the request with formData
              xhr.send(formData);
            });

          }
        }
      }
      // Send the request with formData
      xhr.send(formData);
    }

  </script>
{% endblock %}

